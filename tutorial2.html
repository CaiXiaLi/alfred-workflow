<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Building a user-ready Workflow &mdash; Alfred-Workflow 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Alfred-Workflow 1.0 documentation" href="index.html" />
    <link rel="next" title="Using Alfred-Workflow" href="howto.html" />
    <link rel="prev" title="Writing a Pinboard.in Workflow with Alfred-Workflow" href="tutorial.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="howto.html" title="Using Alfred-Workflow"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="Writing a Pinboard.in Workflow with Alfred-Workflow"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Alfred-Workflow 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="building-a-user-ready-workflow">
<span id="tutorial2"></span><h1>Building a user-ready Workflow<a class="headerlink" href="#building-a-user-ready-workflow" title="Permalink to this headline">¶</a></h1>
<p>In which we create a <a class="reference external" href="https://pinboard.in/">Pinboard.in</a> Workflow ready for
the masses.</p>
<p>In the <a class="reference internal" href="tutorial.html#tutorial"><em>first part</em></a> of the tutorial, we built a useable Workflow
to view, search and open your recent Pinboard posts. The Workflow isn&#8217;t quite
ready to be distributed to other users however: we can&#8217;t expect them to go
grubbing around in the source code, changing constants like an animal to set
their own API key.</p>
<p>What&#8217;s more, an update to the Workflow would overwrite their changes.</p>
<p>So now we&#8217;re going to edit the Workflow so users can add their API key from the
comfort of Alfred&#8217;s friendly query box and use <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.settings" title="workflow.workflow.Workflow.settings"><tt class="xref py py-attr docutils literal"><span class="pre">settings</span></tt></a>
to save it in the Workflow&#8217;s data directory where it won&#8217;t get overwritten.</p>
<div class="section" id="performing-multiple-actions-from-one-script">
<h2>Performing multiple actions from one script<a class="headerlink" href="#performing-multiple-actions-from-one-script" title="Permalink to this headline">¶</a></h2>
<p>To set the user&#8217;s API key, we&#8217;re going to need a new action. We could write a
second script to do this, but we&#8217;re going to stick with one script and make it
smart enough to do two things, instead. The advantage of using one script is
that if you build a workflow with lots of actions, you don&#8217;t have a dozen or more
scripts to manage.</p>
<p>We&#8217;ll start by adding an argument parser (using <a class="reference external" href="http://docs.python.org/library/argparse.html#module-argparse" title="(in Python v2.7)"><tt class="xref py py-mod docutils literal"><span class="pre">argparse</span></tt></a>) to <tt class="docutils literal"><span class="pre">main</span></tt> and some
<tt class="docutils literal"><span class="pre">if</span></tt>-statements to alter the script behaviour depending on the arguments passed
to the script.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112</pre></div></td><td class="code"><div class="highlight"><pre> <span class="c"># encoding: utf-8</span>

 <span class="kn">import</span> <span class="nn">sys</span>
 <span class="kn">import</span> <span class="nn">argparse</span>
<span class="hll"> <span class="kn">from</span> <span class="nn">workflow</span> <span class="kn">import</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">ICON_WEB</span><span class="p">,</span> <span class="n">ICON_WARNING</span><span class="p">,</span> <span class="n">web</span>
</span>

<span class="hll"> <span class="k">def</span> <span class="nf">get_recent_posts</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
</span><span class="hll">     <span class="sd">&quot;&quot;&quot;Retrieve recent posts from Pinboard.in</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">     Returns a list of post dictionaries.</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">     &quot;&quot;&quot;</span>
</span><span class="hll">     <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;https://api.pinboard.in/v1/posts/recent&#39;</span>
</span><span class="hll">     <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">auth_token</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;json&#39;</span><span class="p">)</span>
</span>     <span class="n">r</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

     <span class="c"># throw an error if request failed</span>
     <span class="c"># Workflow will catch this and show it to the user</span>
     <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

     <span class="c"># Parse the JSON returned by pinboard and extract the posts</span>
     <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
     <span class="n">posts</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;posts&#39;</span><span class="p">]</span>
     <span class="k">return</span> <span class="n">posts</span>


 <span class="k">def</span> <span class="nf">search_key_for_post</span><span class="p">(</span><span class="n">post</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;Generate a string search key for a post&quot;&quot;&quot;</span>
     <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
     <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">])</span>  <span class="c"># title of post</span>
     <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">])</span>  <span class="c"># post tags</span>
     <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;extended&#39;</span><span class="p">])</span>  <span class="c"># description</span>
     <span class="k">return</span> <span class="s">u&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>


 <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">wf</span><span class="p">):</span>

<span class="hll">     <span class="c"># build argument parser to parse script args and collect their</span>
</span><span class="hll">     <span class="c"># values</span>
</span><span class="hll">     <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span><span class="hll">     <span class="c"># add an optional (nargs=&#39;?&#39;) --setkey argument and save its</span>
</span><span class="hll">     <span class="c"># value to &#39;apikey&#39; (dest). This will be called from a separate &quot;Run Script&quot;</span>
</span><span class="hll">     <span class="c"># action with the API key</span>
</span><span class="hll">     <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--setkey&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;apikey&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</span><span class="hll">     <span class="c"># add an optional query and save it to &#39;query&#39;</span>
</span><span class="hll">     <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;query&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</span><span class="hll">     <span class="c"># parse the script&#39;s arguments</span>
</span><span class="hll">     <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">     <span class="c">####################################################################</span>
</span><span class="hll">     <span class="c"># Save the provided API key</span>
</span><span class="hll">     <span class="c">####################################################################</span>
</span><span class="hll">
</span><span class="hll">     <span class="c"># decide what to do based on arguments</span>
</span><span class="hll">     <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">apikey</span><span class="p">:</span>  <span class="c"># Script was passed an API key</span>
</span><span class="hll">         <span class="c"># save the key</span>
</span><span class="hll">         <span class="n">wf</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;api_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">apikey</span>
</span><span class="hll">         <span class="k">return</span> <span class="mi">0</span>  <span class="c"># 0 means script exited cleanly</span>
</span><span class="hll">
</span><span class="hll">     <span class="c">####################################################################</span>
</span><span class="hll">     <span class="c"># Check that we have an API key saved</span>
</span><span class="hll">     <span class="c">####################################################################</span>
</span><span class="hll">
</span><span class="hll">     <span class="n">api_key</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;api_key&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</span><span class="hll">     <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>  <span class="c"># API key has not yet been set</span>
</span><span class="hll">         <span class="n">wf</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s">&#39;No API key set.&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="s">&#39;Please use pbsetkey to set your Pinboard API key.&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">valid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">icon</span><span class="o">=</span><span class="n">ICON_WARNING</span><span class="p">)</span>
</span><span class="hll">         <span class="n">wf</span><span class="o">.</span><span class="n">send_feedback</span><span class="p">()</span>
</span><span class="hll">         <span class="k">return</span> <span class="mi">0</span>
</span><span class="hll">
</span><span class="hll">     <span class="c">####################################################################</span>
</span><span class="hll">     <span class="c"># View/filter Pinboard posts</span>
</span><span class="hll">     <span class="c">####################################################################</span>
</span><span class="hll">
</span><span class="hll">     <span class="n">query</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">query</span>
</span><span class="hll">     <span class="c"># Retrieve posts from cache if available and no more than 600</span>
</span><span class="hll">     <span class="c"># seconds old</span>
</span><span class="hll">
</span><span class="hll">     <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span>
</span><span class="hll">         <span class="sd">&quot;&quot;&quot;`cached_data` can only take a bare callable (no args),</span>
</span><span class="hll"><span class="sd">         so we need to wrap callables needing arguments in a function</span>
</span><span class="hll"><span class="sd">         that needs none.</span>
</span><span class="hll"><span class="sd">         &quot;&quot;&quot;</span>
</span><span class="hll">         <span class="k">return</span> <span class="n">get_recent_posts</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">     <span class="n">posts</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">cached_data</span><span class="p">(</span><span class="s">&#39;posts&#39;</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
</span>
     <span class="c"># If script was passed a query, use it to filter posts</span>
     <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
         <span class="n">posts</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">posts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">search_key_for_post</span><span class="p">)</span>

     <span class="c"># Loop through the returned posts and add a item for each to</span>
     <span class="c"># the list of results for Alfred</span>
     <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
         <span class="n">wf</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
         <span class="n">wf</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">],</span>
                     <span class="n">subtitle</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;href&#39;</span><span class="p">],</span>
                     <span class="n">arg</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;href&#39;</span><span class="p">],</span>
                     <span class="n">valid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">icon</span><span class="o">=</span><span class="n">ICON_WEB</span><span class="p">)</span>

     <span class="c"># Send the results to Alfred as XML</span>
     <span class="n">wf</span><span class="o">.</span><span class="n">send_feedback</span><span class="p">()</span>
     <span class="k">return</span> <span class="mi">0</span>


 <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">u&quot;__main__&quot;</span><span class="p">:</span>
     <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">()</span>
     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p>Quite a lot has happened here: at the top, we&#8217;re importing a couple more icons
that we use in <tt class="docutils literal"><span class="pre">main</span></tt> to notify the user that their API key is missing and
that they should set it.</p>
<p>We&#8217;ve adapted <tt class="docutils literal"><span class="pre">get_recent_posts</span></tt> to accept an <tt class="docutils literal"><span class="pre">api_key</span></tt> argument. We <em>could</em>
continue to use the <tt class="docutils literal"><span class="pre">API_KEY</span></tt> global variable, but that&#8217;s considered bad form.</p>
<p>As a result of this, we&#8217;ve had to alter the way
<a class="reference internal" href="workflow.html#workflow.workflow.Workflow.cached_data" title="workflow.workflow.Workflow.cached_data"><tt class="xref py py-meth docutils literal"><span class="pre">cached_data()</span></tt></a> is called. It can&#8217;t call a function
that requires any arguments, so we&#8217;ve added a <tt class="docutils literal"><span class="pre">wrapper</span></tt> function within <tt class="docutils literal"><span class="pre">main</span></tt>
that calls <tt class="docutils literal"><span class="pre">get_recent_posts</span></tt> with the necessary <tt class="docutils literal"><span class="pre">api_key</span></tt> arguments, and
we pass this <tt class="docutils literal"><span class="pre">wrapper</span></tt> function (which needs no arguments) to
<a class="reference internal" href="workflow.html#workflow.workflow.Workflow.cached_data" title="workflow.workflow.Workflow.cached_data"><tt class="xref py py-meth docutils literal"><span class="pre">cached_data()</span></tt></a> instead.</p>
<p>At the top of <tt class="docutils literal"><span class="pre">main</span></tt>, we&#8217;ve added an argument parser using <a class="reference external" href="http://docs.python.org/library/argparse.html#module-argparse" title="(in Python v2.7)"><tt class="xref py py-mod docutils literal"><span class="pre">argparse</span></tt></a>
that can take an optional <tt class="docutils literal"><span class="pre">--apikey</span> <span class="pre">APIKEY</span></tt> argument and an optional <tt class="docutils literal"><span class="pre">query</span></tt>
argument (remember the script doesn&#8217;t require a query).</p>
<p>Then we check if an API key was passed using <tt class="docutils literal"><span class="pre">--apikey</span></tt>. If it was, we save
it using <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.settings" title="workflow.workflow.Workflow.settings"><tt class="xref py py-attr docutils literal"><span class="pre">settings</span></tt></a> (see <cite>below &lt;settings&gt;</cite>).</p>
<p>Once this is done, we post a message to the user informing them that their API
key has been saved and exit the script.</p>
<p>If no API key was specified with <tt class="docutils literal"><span class="pre">--apikey</span></tt>, we try to show/filter Pinboard
posts as before. But first of all, we now have to check to see if we already
have an API key saved. If not, we show the user a warning (No API key set) and
exit the script.</p>
<p>Finally, if we have an API key saved, we retrieve it and show/filter the Pinboard
posts just as before.</p>
<p>Of course, we don&#8217;t have an API key saved, and we haven&#8217;t yet set up our Workflow
in Alfred to save one, so the Workflow currently won&#8217;t work. Try to run it,
and you&#8217;ll see the warning we just implemented:</p>
<img alt="_images/screen15_no_api_key.png" src="_images/screen15_no_api_key.png" />
<p>So let&#8217;s add that functionality now.</p>
</div>
<div class="section" id="multi-step-actions">
<h2>Multi-step actions<a class="headerlink" href="#multi-step-actions" title="Permalink to this headline">¶</a></h2>
<p>Asking the user for input and saving it is best done in two steps:</p>
<ol class="arabic simple">
<li>Ask for the data.</li>
<li>Pass it to a second action to save it.</li>
</ol>
<p>A Script Filter is designed to be called constantly by Alfred and return results.
This time, we just want to get some data, so we&#8217;ll use a <strong>Keyword</strong> input instead.</p>
<p>Go back to your Workflow in Alfred&#8217;s Preferences and add a <strong>Keyword</strong> input:</p>
<img alt="_images/screen16_keyword.png" src="_images/screen16_keyword.png" />
<p>And set it up as follows (we&#8217;ll use the keyword <tt class="docutils literal"><span class="pre">pbsetkey</span></tt> because that&#8217;s what we told the user to use
in the above warning message):</p>
<img alt="_images/screen17_set_apikey_keyword.png" src="_images/screen17_set_apikey_keyword.png" />
<p>You can now enter <tt class="docutils literal"><span class="pre">pbsetkey</span></tt> in Alfred and see the following:</p>
<img alt="_images/screen18_pbsetkey.png" src="_images/screen18_pbsetkey.png" />
<p>It won&#8217;t do anything yet, though, as we haven&#8217;t connected its output to anything.</p>
<p>Back in Alfred&#8217;s Preferences, add a <strong>Run Script</strong> action:</p>
<img alt="_images/screen19_runscript.png" src="_images/screen19_runscript.png" />
<p>and point it at our <tt class="docutils literal"><span class="pre">pinboard.py</span></tt> script with the <tt class="docutils literal"><span class="pre">--setkey</span></tt> argument:</p>
<img alt="_images/screen20_runscript_settings.png" src="_images/screen20_runscript_settings.png" />
<p>Finally, connect the <tt class="docutils literal"><span class="pre">pbsetkey</span></tt> <strong>Keyword</strong> to the new <strong>Run Script</strong> action:</p>
<img alt="_images/screen21_connection.png" src="_images/screen21_connection.png" />
<p>Now you can call <tt class="docutils literal"><span class="pre">pbsetkey</span></tt> in Alfred, paste in your Pinboard API key and hit
<strong>ENTER</strong>. It will be saved by the Workflow and <tt class="docutils literal"><span class="pre">pbrecent</span></tt> will once again
work as expected. Try it.</p>
<p>It&#8217;s a little confusing receiving no feedback on whether the key was saved or not,
so go back into Alfred&#8217;s Preferences, and add an <strong>Output &gt; Post Notification</strong>
action to your Workflow:</p>
<img alt="_images/screen22_add_notification.png" src="_images/screen22_add_notification.png" />
<p>In the resulting pop-up, enter a message to be shown in Notification Center:</p>
<img alt="_images/screen22_notification_settings.png" src="_images/screen22_notification_settings.png" />
<p>and connect the <strong>Run Script</strong> we just added to it:</p>
<img alt="_images/screen23_three_way.png" src="_images/screen23_three_way.png" />
<p>Try setting your API key again with <tt class="docutils literal"><span class="pre">pbsetkey</span></tt> and this time you&#8217;ll get a
notification that it was saved.</p>
</div>
<div class="section" id="saving-settings">
<span id="settings"></span><h2>Saving settings<a class="headerlink" href="#saving-settings" title="Permalink to this headline">¶</a></h2>
<p>Saving the API key was pretty easy (1 line of code). <a class="reference internal" href="workflow.html#workflow.workflow.Settings" title="workflow.workflow.Settings"><tt class="xref py py-class docutils literal"><span class="pre">Settings</span></tt></a>
is a special dictionary that automatically saves itself when you change its
contents. It can be used much like a normal dictionary with the caveat that all
values must be serialisable to JSON as the settings are saved as a JSON file in
the Workflow&#8217;s data directory.</p>
<p>Very simple, yes, but secure? No. A better place to save the API key would be
in the user&#8217;s Keychain. Let&#8217;s do that.</p>
</div>
<div class="section" id="saving-settings-securely">
<h2>Saving settings securely<a class="headerlink" href="#saving-settings-securely" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="workflow.html#workflow.workflow.Workflow" title="workflow.workflow.Workflow"><tt class="xref py py-class docutils literal"><span class="pre">Workflow</span></tt></a> provides three methods for managing data
saved in OS X&#8217;s Keychain: <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.get_password" title="workflow.workflow.Workflow.get_password"><tt class="xref py py-meth docutils literal"><span class="pre">get_password()</span></tt></a>,
<a class="reference internal" href="workflow.html#workflow.workflow.Workflow.save_password" title="workflow.workflow.Workflow.save_password"><tt class="xref py py-meth docutils literal"><span class="pre">save_password()</span></tt></a> and <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.delete_password" title="workflow.workflow.Workflow.delete_password"><tt class="xref py py-meth docutils literal"><span class="pre">delete_password()</span></tt></a>.</p>
<p>They are all called with an <tt class="docutils literal"><span class="pre">account</span></tt> name and an optional <tt class="docutils literal"><span class="pre">service</span></tt> name
(by default, this is your Workflow&#8217;s <tt class="docutils literal"><span class="pre">bundle</span> <span class="pre">ID</span></tt>).</p>
<p>Change your <tt class="docutils literal"><span class="pre">pinboard.py</span></tt> script as follows to use Keychain instead of a JSON
file to store your API key:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113</pre></div></td><td class="code"><div class="highlight"><pre> <span class="c"># encoding: utf-8</span>

 <span class="kn">import</span> <span class="nn">sys</span>
 <span class="kn">import</span> <span class="nn">argparse</span>
<span class="hll"> <span class="kn">from</span> <span class="nn">workflow</span> <span class="kn">import</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">ICON_WEB</span><span class="p">,</span> <span class="n">ICON_WARNING</span><span class="p">,</span> <span class="n">web</span><span class="p">,</span> <span class="n">PasswordNotFound</span>
</span>

 <span class="k">def</span> <span class="nf">get_recent_posts</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;Retrieve recent posts from Pinboard.in</span>

<span class="sd">     Returns a list of post dictionaries.</span>

<span class="sd">     &quot;&quot;&quot;</span>
     <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;https://api.pinboard.in/v1/posts/recent&#39;</span>
     <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">auth_token</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;json&#39;</span><span class="p">)</span>
     <span class="n">r</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

     <span class="c"># throw an error if request failed</span>
     <span class="c"># Workflow will catch this and show it to the user</span>
     <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

     <span class="c"># Parse the JSON returned by pinboard and extract the posts</span>
     <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
     <span class="n">posts</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;posts&#39;</span><span class="p">]</span>
     <span class="k">return</span> <span class="n">posts</span>


 <span class="k">def</span> <span class="nf">search_key_for_post</span><span class="p">(</span><span class="n">post</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;Generate a string search key for a post&quot;&quot;&quot;</span>
     <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
     <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">])</span>  <span class="c"># title of post</span>
     <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">])</span>  <span class="c"># post tags</span>
     <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;extended&#39;</span><span class="p">])</span>  <span class="c"># description</span>
     <span class="k">return</span> <span class="s">u&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>


 <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">wf</span><span class="p">):</span>

     <span class="c"># build argument parser to parse script args and collect their</span>
     <span class="c"># values</span>
     <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
     <span class="c"># add an optional (nargs=&#39;?&#39;) --apikey argument and save its</span>
     <span class="c"># value to &#39;apikey&#39; (dest). This will be called from a separate &quot;Run Script&quot;</span>
     <span class="c"># action with the API key</span>
     <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--setkey&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;apikey&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
     <span class="c"># add an optional query and save it to &#39;query&#39;</span>
     <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;query&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
     <span class="c"># parse the script&#39;s arguments</span>
     <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

     <span class="c">####################################################################</span>
     <span class="c"># Save the provided API key</span>
     <span class="c">####################################################################</span>

     <span class="c"># decide what to do based on arguments</span>
     <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">apikey</span><span class="p">:</span>  <span class="c"># Script was passed an API key</span>
         <span class="c"># save the key</span>
<span class="hll">         <span class="n">wf</span><span class="o">.</span><span class="n">save_password</span><span class="p">(</span><span class="s">&#39;pinboard_api_key&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">apikey</span><span class="p">)</span>
</span>         <span class="k">return</span> <span class="mi">0</span>  <span class="c"># 0 means script exited cleanly</span>

     <span class="c">####################################################################</span>
     <span class="c"># Check that we have an API key saved</span>
     <span class="c">####################################################################</span>

<span class="hll">     <span class="k">try</span><span class="p">:</span>
</span><span class="hll">         <span class="n">api_key</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">get_password</span><span class="p">(</span><span class="s">&#39;pinboard_api_key&#39;</span><span class="p">)</span>
</span><span class="hll">     <span class="k">except</span> <span class="n">PasswordNotFound</span><span class="p">:</span>  <span class="c"># API key has not yet been set</span>
</span><span class="hll">         <span class="n">wf</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s">&#39;No API key set.&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="s">&#39;Please use pbsetkey to set your Pinboard API key.&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">valid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">icon</span><span class="o">=</span><span class="n">ICON_WARNING</span><span class="p">)</span>
</span><span class="hll">         <span class="n">wf</span><span class="o">.</span><span class="n">send_feedback</span><span class="p">()</span>
</span>         <span class="k">return</span> <span class="mi">0</span>

     <span class="c">####################################################################</span>
     <span class="c"># View/filter Pinboard posts</span>
     <span class="c">####################################################################</span>

     <span class="n">query</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">query</span>
     <span class="c"># Retrieve posts from cache if available and no more than 600</span>
     <span class="c"># seconds old</span>

     <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span>
         <span class="sd">&quot;&quot;&quot;`cached_data` can only take a bare callable (no args),</span>
<span class="sd">         so we need to wrap callables needing arguments in a function</span>
<span class="sd">         that needs none.</span>
<span class="sd">         &quot;&quot;&quot;</span>
         <span class="k">return</span> <span class="n">get_recent_posts</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>

     <span class="n">posts</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">cached_data</span><span class="p">(</span><span class="s">&#39;posts&#39;</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>

     <span class="c"># If script was passed a query, use it to filter posts</span>
     <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
         <span class="n">posts</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">posts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">search_key_for_post</span><span class="p">)</span>

     <span class="c"># Loop through the returned posts and add a item for each to</span>
     <span class="c"># the list of results for Alfred</span>
     <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
         <span class="n">wf</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
         <span class="n">wf</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">],</span>
                     <span class="n">subtitle</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;href&#39;</span><span class="p">],</span>
                     <span class="n">arg</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;href&#39;</span><span class="p">],</span>
                     <span class="n">valid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">icon</span><span class="o">=</span><span class="n">ICON_WEB</span><span class="p">)</span>

     <span class="c"># Send the results to Alfred as XML</span>
     <span class="n">wf</span><span class="o">.</span><span class="n">send_feedback</span><span class="p">()</span>
     <span class="k">return</span> <span class="mi">0</span>


 <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">u&quot;__main__&quot;</span><span class="p">:</span>
     <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">()</span>
     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference internal" href="workflow.html#workflow.workflow.Workflow.get_password" title="workflow.workflow.Workflow.get_password"><tt class="xref py py-meth docutils literal"><span class="pre">get_password()</span></tt></a> raises a
<tt class="xref py py-class docutils literal"><span class="pre">PasswordNotFound</span></tt> exception if the requested
password isn&#8217;t in your Keychain, so we import <tt class="xref py py-class docutils literal"><span class="pre">PasswordNotFound</span></tt>
and change <tt class="docutils literal"><span class="pre">if</span> <span class="pre">not</span> <span class="pre">api_key</span></tt> to a <tt class="docutils literal"><span class="pre">try</span> <span class="pre">...</span> <span class="pre">except</span></tt> clause.</p>
<p>Try running your Workflow again. It will complain that you haven&#8217;t saved your
API key (it&#8217;s looking in Keychain now, not the settings), so set your API key
once again, and you should be able to browse your recent posts in Alfred once more.</p>
<p>And if you open <strong>Keychain Access</strong>, you&#8217;ll find the API key safely tucked away
in your Keychain:</p>
<img alt="_images/screen24_keychain.png" src="_images/screen24_keychain.png" />
<p>As a bonus, if you have multiple Macs and use iCloud Keychain, the API key will
be seamlessly synced across machines, saving you the trouble of setting up the
Workflow multiple times.</p>
</div>
<div class="section" id="magic-arguments">
<h2>&#8220;Magic&#8221; arguments<a class="headerlink" href="#magic-arguments" title="Permalink to this headline">¶</a></h2>
<p>Now that the API key is stored in Keychain, we don&#8217;t need it saved in the
Workflow&#8217;s settings any more (and having it there that kind of defeats the
purpose of using Keychain). To get rid of it, we can use one of <strong>Alfred-Workflow</strong>&#8216;s
&#8220;magic&#8221; arguments: <tt class="docutils literal"><span class="pre">workflow:delsettings</span></tt>.</p>
<p>Open up Alfred, and enter <tt class="docutils literal"><span class="pre">pbrecent</span> <span class="pre">workflow:delsettings</span></tt>. You should see the
following message:</p>
<img alt="_images/screen25_magic.png" src="_images/screen25_magic.png" />
<p><strong>Alfred-Workflow</strong> has recognised one of its &#8220;magic&#8221; arguments, performed the
appropriate action, posted a notification and exited the Workflow.</p>
<p>Currently, the following magic arguments are available:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">workflow:delsettings</span></tt> — deletes the Workflow&#8217;s settings file</li>
<li><tt class="docutils literal"><span class="pre">workflow:delcache</span></tt> — clears the Workflow&#8217;s cache</li>
<li><tt class="docutils literal"><span class="pre">workflow:openlog</span></tt> — open the Workflow&#8217;s log file in the default application (usually <strong>Console.app</strong>)</li>
</ul>
<p>These are to aid coders in the development and debugging of Workflows. In particular,
it makes debugging errors encountered by Terminal-averse users much easier: any
exceptions raised within the <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.run" title="workflow.workflow.Workflow.run"><tt class="xref py py-meth docutils literal"><span class="pre">run()</span></tt></a> method are
logged together with the corresponding traceback, and you can ask users to call
your Workflow&#8217;s keyword with the <tt class="docutils literal"><span class="pre">workflow:openlog</span></tt> query to more easily send
you the contents of the log.</p>
<p><strong>Note:</strong> magic arguments will only work with scripts that accept arguments <em>and</em>
use the <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.args" title="workflow.workflow.Workflow.args"><tt class="xref py py-attr docutils literal"><span class="pre">args</span></tt></a> property (where &#8220;magic&#8221; arguments
are parsed).</p>
<p>You can turn off magic arguments by passing <tt class="docutils literal"><span class="pre">capture_args=False</span></tt> to
<a class="reference internal" href="workflow.html#workflow.workflow.Workflow" title="workflow.workflow.Workflow"><tt class="xref py py-class docutils literal"><span class="pre">Workflow</span></tt></a> on instantiation, or call the corresponding
<a class="reference internal" href="workflow.html#workflow.workflow.Workflow.open_log" title="workflow.workflow.Workflow.open_log"><tt class="xref py py-meth docutils literal"><span class="pre">open_log()</span></tt></a>, <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.clear_cache" title="workflow.workflow.Workflow.clear_cache"><tt class="xref py py-meth docutils literal"><span class="pre">clear_cache()</span></tt></a>
and <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.clear_settings" title="workflow.workflow.Workflow.clear_settings"><tt class="xref py py-meth docutils literal"><span class="pre">clear_settings()</span></tt></a> methods directly, perhaps
assigning them to your own Keywords.</p>
</div>
<div class="section" id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>There&#8217;s a log, you say? Yup. There&#8217;s a <a class="reference external" href="http://docs.python.org/library/logging.html#logging.Logger" title="(in Python v2.7)"><tt class="xref py py-class docutils literal"><span class="pre">logging.Logger</span></tt></a>
instance at <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.logger" title="workflow.workflow.Workflow.logger"><tt class="xref py py-attr docutils literal"><span class="pre">Workflow.logger</span></tt></a> configured to output to
both the Terminal and your Workflow&#8217;s log file. Normally, I use it like this:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre> <span class="kn">from</span> <span class="nn">workflow</span> <span class="kn">import</span> <span class="n">Workflow</span>

 <span class="n">log</span> <span class="o">=</span> <span class="bp">None</span>


 <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">wf</span><span class="p">):</span>
     <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Started&#39;</span><span class="p">)</span>

 <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
     <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">()</span>
     <span class="n">log</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">logger</span>
     <span class="n">wf</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Assigning <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.logger" title="workflow.workflow.Workflow.logger"><tt class="xref py py-attr docutils literal"><span class="pre">logger</span></tt></a> to the module-global <tt class="docutils literal"><span class="pre">log</span></tt>
means it can be accessed from within any function without having to pass the
<a class="reference internal" href="workflow.html#workflow.workflow.Workflow" title="workflow.workflow.Workflow"><tt class="xref py py-class docutils literal"><span class="pre">Workflow</span></tt></a> or <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.logger" title="workflow.workflow.Workflow.logger"><tt class="xref py py-attr docutils literal"><span class="pre">logger</span></tt></a>
instance around.</p>
</div>
<div class="section" id="spit-and-polish">
<h2>Spit and polish<a class="headerlink" href="#spit-and-polish" title="Permalink to this headline">¶</a></h2>
<p>So far, the Workflow&#8217;s looking pretty good. But there are still a couple of things
that could be better. For one, it&#8217;s not necessarily obvious to a user where to
find their Pinboard API key (it took me a good, hard Googling to find it while
writing these tutorials). For another, the Workflow is unresponsive while updating
the list of recent posts from Pinboard. That can&#8217;t be helped if we don&#8217;t have any
posts cached, but apart from the very first run, we always will, so why don&#8217;t
we show what we have and update in the background?</p>
<p>Let&#8217;s fix those issues. The easy one first.</p>
</div>
<div class="section" id="two-actions-one-keyword">
<h2>Two actions, one keyword<a class="headerlink" href="#two-actions-one-keyword" title="Permalink to this headline">¶</a></h2>
<p>To solve the first issue (Pinboard API keys being hard to find), we&#8217;ll add a second
<strong>Keyword</strong> input that responds to the same <tt class="docutils literal"><span class="pre">pbsetkey</span></tt> keyword as our other
action, but this one will just send the user to the Pinboard
<a class="reference external" href="https://pinboard.in/settings/password">password settings page</a> where the API
keys are kept.</p>
<p>Go back to your Workflow in Alfred&#8217;s Preferences and add a new <strong>Keyword</strong> with
the following settings:</p>
<img alt="_images/screen26_keyword2.png" src="_images/screen26_keyword2.png" />
<p>Now when you type <tt class="docutils literal"><span class="pre">pbsetkey</span></tt> into Alfred, you should see two options:</p>
<img alt="_images/screen27_1_keyword_2_actions.png" src="_images/screen27_1_keyword_2_actions.png" />
<p>The second action doesn&#8217;t do anything yet, of course, because we haven&#8217;t connected
it to anything. So add an <strong>Open URL</strong> action in Alfred, enter this URL:</p>
<p><a class="reference external" href="https://pinboard.in/settings/password">https://pinboard.in/settings/password</a></p>
<p>and leave all the settings at their defaults.</p>
<img alt="_images/screen28_open_url.png" src="_images/screen28_open_url.png" />
<p>Finally, connect your new <strong>Keyword</strong> to the new <strong>Open URL</strong> action:</p>
<img alt="_images/screen29_link.png" src="_images/screen29_link.png" />
<p>Enter <tt class="docutils literal"><span class="pre">pbsetkey</span></tt> into Alfred once more and try out the new action. Pinboard
should open in your default browser.</p>
<p>Easy peasy.</p>
</div>
<div class="section" id="like-greased-lightning-background-updates">
<h2>Like greased lightning: background updates<a class="headerlink" href="#like-greased-lightning-background-updates" title="Permalink to this headline">¶</a></h2>
<p>All that remains is for our Workflow to provide the blazing fast results Alfred
users have come to expect. No waiting around for glacial web services for the
likes of us. As long as we have some posts saved in the cache, we can show those
while grabbing an updated list in the background (and notifying the user of
the update, of course).</p>
<p>Now, there are a few different ways to start a background process. We could ask the user
to set up a <tt class="docutils literal"><span class="pre">cron</span></tt> job, but <tt class="docutils literal"><span class="pre">cron</span></tt> isn&#8217;t the easiest software to use. We could
add and load a Launch Agent, but that&#8217;d run indefinitely, whether or not the
Workflow is being used, and even if the Workflow were uninstalled. So we&#8217;d
best start our background process from within the Workflow itself.</p>
<p>Normally, you&#8217;d use <a class="reference external" href="http://docs.python.org/library/subprocess.html#subprocess.Popen" title="(in Python v2.7)"><tt class="xref py py-class docutils literal"><span class="pre">subprocess.Popen</span></tt></a> to start a background process, but
that doesn&#8217;t work quite as you might expect in Alfred: it treats your Workflow
as still running till the background process has finished, too, so it won&#8217;t call
your Workflow with a new query till the Pinboard update is done. Which is
exactly what happens now and the behaviour we want to avoid.</p>
<p>To solve this problem, we&#8217;re still going to use <a class="reference external" href="http://docs.python.org/library/subprocess.html#module-subprocess" title="(in Python v2.7)"><tt class="xref py py-mod docutils literal"><span class="pre">subprocess</span></tt></a>, but
our updater script is going to fork into the background and become a (short-running)
daemon process before performing the update. This way, it will appear to exit
immediately, so Alfred will keep on calling our Workflow every time the query changes.</p>
<p>Meanwhile, our main Workflow script will check if the background updater is
running and post a useful, friendly notification if it is.</p>
<p>Let&#8217;s have at it.</p>
<div class="section" id="background-updater-script">
<h3>Background updater script<a class="headerlink" href="#background-updater-script" title="Permalink to this headline">¶</a></h3>
<p>Create a new file in the Workflow root directory called <tt class="docutils literal"><span class="pre">update.py</span></tt> with these
contents:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124</pre></div></td><td class="code"><div class="highlight"><pre> <span class="c"># encoding: utf-8</span>


 <span class="kn">import</span> <span class="nn">os</span>
 <span class="kn">import</span> <span class="nn">sys</span>

 <span class="kn">from</span> <span class="nn">workflow</span> <span class="kn">import</span> <span class="n">web</span><span class="p">,</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">PasswordNotFound</span>


 <span class="k">def</span> <span class="nf">get_recent_posts</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;Retrieve recent posts from Pinboard.in</span>

<span class="sd">     Returns a list of post dictionaries.</span>

<span class="sd">     &quot;&quot;&quot;</span>
     <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;https://api.pinboard.in/v1/posts/recent&#39;</span>
     <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">auth_token</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;json&#39;</span><span class="p">)</span>
     <span class="n">r</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

     <span class="c"># throw an error if request failed</span>
     <span class="c"># Workflow will catch this and show it to the user</span>
     <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

     <span class="c"># Parse the JSON returned by pinboard and extract the posts</span>
     <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
     <span class="n">posts</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;posts&#39;</span><span class="p">]</span>
     <span class="k">return</span> <span class="n">posts</span>


 <span class="k">def</span> <span class="nf">process_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;Does a process with PID `pid` actually exist?&quot;&quot;&quot;</span>

     <span class="k">try</span><span class="p">:</span>
         <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
     <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>  <span class="c"># not running</span>
         <span class="k">return</span> <span class="bp">False</span>
     <span class="k">return</span> <span class="bp">True</span>


 <span class="k">def</span> <span class="nf">daemonise</span><span class="p">(</span><span class="n">stdin</span><span class="o">=</span><span class="s">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="s">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="s">&#39;/dev/null&#39;</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;This forks the current process into a daemon.</span>
<span class="sd">     The stdin, stdout, and stderr arguments are file names that</span>
<span class="sd">     will be opened and be used to replace the standard file descriptors</span>
<span class="sd">     in sys.stdin, sys.stdout, and sys.stderr.</span>
<span class="sd">     These arguments are optional and default to /dev/null.</span>
<span class="sd">     Note that stderr is opened unbuffered, so</span>
<span class="sd">     if it shares a file with stdout then interleaved output</span>
<span class="sd">     may not appear in the order that you expect.</span>

<span class="sd">     &quot;&quot;&quot;</span>

     <span class="c"># Do first fork.</span>
     <span class="k">try</span><span class="p">:</span>
         <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
         <span class="k">if</span> <span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># Exit first parent.</span>
     <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
         <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;fork #1 failed: (</span><span class="si">%d</span><span class="s">) </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
         <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
     <span class="c"># Decouple from parent environment.</span>
     <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
     <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
     <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">()</span>
     <span class="c"># Do second fork.</span>
     <span class="k">try</span><span class="p">:</span>
         <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
         <span class="k">if</span> <span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># Exit second parent.</span>
     <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
         <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;fork #2 failed: (</span><span class="si">%d</span><span class="s">) </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
         <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
     <span class="c"># Now I am a daemon!</span>
     <span class="c"># Redirect standard file descriptors.</span>
     <span class="n">si</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
     <span class="n">so</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#39;a+&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
     <span class="n">se</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;a+&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
     <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
     <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
     <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">se</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>


 <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">wf</span><span class="p">):</span>
     <span class="c"># First check if a copy of this script is already running</span>
     <span class="n">pidfile</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">cachefile</span><span class="p">(</span><span class="s">&#39;update.pid&#39;</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pidfile</span><span class="p">):</span>
         <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">pidfile</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
         <span class="k">if</span> <span class="n">process_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
             <span class="n">wf</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Update script is already running&#39;</span><span class="p">)</span>
             <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

     <span class="c"># Fork into background</span>
     <span class="n">daemonise</span><span class="p">()</span>
     <span class="c"># Save PID of this process</span>
     <span class="nb">open</span><span class="p">(</span><span class="n">pidfile</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>
     <span class="k">try</span><span class="p">:</span>
         <span class="c"># Get API key from Keychain</span>
         <span class="n">api_key</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">get_password</span><span class="p">(</span><span class="s">&#39;pinboard_api_key&#39;</span><span class="p">)</span>

         <span class="c"># Retrieve posts from cache if available and no more than 600</span>
         <span class="c"># seconds old</span>

         <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span>
             <span class="sd">&quot;&quot;&quot;`cached_data` can only take a bare callable (no args),</span>
<span class="sd">             so we need to wrap callables needing arguments in a function</span>
<span class="sd">             that needs none.</span>
<span class="sd">             &quot;&quot;&quot;</span>
             <span class="k">return</span> <span class="n">get_recent_posts</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>

         <span class="n">posts</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">cached_data</span><span class="p">(</span><span class="s">&#39;posts&#39;</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
         <span class="c"># Record our progress in the log file</span>
         <span class="n">wf</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;{} Pinboard posts cached&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">posts</span><span class="p">)))</span>

     <span class="k">except</span> <span class="n">PasswordNotFound</span><span class="p">:</span>  <span class="c"># API key has not yet been set</span>
         <span class="c"># Nothing we can do about this, so just log it</span>
         <span class="n">wf</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;No API key saved&#39;</span><span class="p">)</span>

     <span class="k">finally</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pidfile</span><span class="p">):</span>
             <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">pidfile</span><span class="p">)</span>


 <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
     <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">()</span>
     <span class="n">wf</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>At the top of the file (line 10), we&#8217;ve copied the <tt class="docutils literal"><span class="pre">get_recent_posts</span></tt> function from
<tt class="docutils literal"><span class="pre">pinboard.py</span></tt> (we won&#8217;t need it there any more).</p>
<p>We&#8217;ve added a new function, <tt class="docutils literal"><span class="pre">process_exists</span></tt>, (line 30) which will tell us if
a specific process is running, and below that (line 40) is the <tt class="docutils literal"><span class="pre">daemonise</span></tt>
function, which <a class="reference external" href="http://www.petercollingridge.co.uk/blog/running-multiple-processes-python">forks</a>
the process into the background and disconnects from the parent process
(allowing it to exit).</p>
<p>Now onto <tt class="docutils literal"><span class="pre">main</span></tt> (line 82). We&#8217;re going to write the PID of our process to a file in the
cache whenever the <tt class="docutils literal"><span class="pre">update.py</span></tt> script runs, and delete it when it finishes.</p>
<p>This allows both <tt class="docutils literal"><span class="pre">update.py</span></tt> and <tt class="docutils literal"><span class="pre">pinboard.py</span></tt> to see if an update is currently
taking place, and if so, to exit or notify the user respectively. If the file
exists (line 84), we read the PID from it and call <tt class="docutils literal"><span class="pre">process_exists</span></tt> to see if
it&#8217;s really running (something may have gone wrong, leaving a stale pidfile).
If the process exists, we exit the script (line 89) as we don&#8217;t want two updates running
simultaneously.</p>
<p>If the script doesn&#8217;t exit immediately because an update is already in progress,
it then forks into the background (line 92), disconnecting from the <tt class="docutils literal"><span class="pre">pinboard.py</span></tt>
process that called it, allowing the latter to exit (and be called again by
Alfred), while the <tt class="docutils literal"><span class="pre">update.py</span></tt> process gets on with the potentially (relatively)
slow business of getting new data from the Pinboard web API.</p>
<p>If there is no pidfile or it contains an invalid PID, we write our own PID to
the pidfile (line 94) and get on with the business of updating. We wrap the code
in a <tt class="docutils literal"><span class="pre">try</span> <span class="pre">…</span> <span class="pre">except</span> <span class="pre">…</span> <span class="pre">finally</span></tt> clause to ensure we delete the pidfile at the end
(lines 117–119).</p>
<p>The <tt class="docutils literal"><span class="pre">except</span></tt> clause (lines 113–115) is to trap the <tt class="xref py py-class docutils literal"><span class="pre">PasswordNotFound</span></tt>
error that <tt class="xref py py-meth docutils literal"><span class="pre">Workflow.get_password()</span></tt> will raise if the user hasn&#8217;t set their
API key via Alfred yet. <tt class="docutils literal"><span class="pre">update.py</span></tt> can quietly die if no API key has been set
because <tt class="docutils literal"><span class="pre">pinboard.py</span></tt> takes care of notifying the user and setting the key.</p>
<p>The contents of the <tt class="docutils literal"><span class="pre">try</span></tt> block (lines 97–109) are once again copied straight
from <tt class="docutils literal"><span class="pre">pinboard.py</span></tt> (where we won&#8217;t be needing them any more).</p>
<p>Let&#8217;s try out <tt class="docutils literal"><span class="pre">update.py</span></tt>. <a class="reference external" href="http://www.youtube.com/watch?v=xsCCgITrrWI">Open a Terminal window at the Workflow root directory</a>
and run the following:</p>
<div class="highlight-python"><div class="highlight"><pre>python update.py
</pre></div>
</div>
<p>If it works, you should see … precisely nothing. Practically the first thing the
script does is fork into the background and disconnect from the world, so if it&#8217;s
working correctly, it should appear to exit instantly with no output.</p>
<p>To see if it&#8217;s worked, we need to look at the log file, which we can open using
one of <strong>Alfred-Workflow</strong>&#8216;s <a class="reference internal" href="howto.html#magic-arguments"><em>&#8220;magic&#8221; arguments</em></a>. Run this
in the Terminal:</p>
<div class="highlight-python"><div class="highlight"><pre>python pinboard.py workflow:openlog
</pre></div>
</div>
<p>And the Workflow log file should open in Console.app. The last few lines of
the log should look very much like this:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre> 21:59:59 workflow.py:855 DEBUG    get_password : net.deanishe.alfred-pinboard-recent:pinboard_api_key
 21:59:59 workflow.py:544 DEBUG    Loading cached data from : /Users/dean/Library/Caches/com.runningwithcrayons.Alfred-2/Workflow Data/net.deanishe.alfred-pinboard-recent/posts.cache
<span class="hll"> 21:59:59 update.py:111 DEBUG    100 Pinboard posts cached
</span> 22:19:25 workflow.py:371 INFO     Opening workflow log file
</pre></div>
</td></tr></table></div>
<p>As you can see in the 3rd line, <tt class="docutils literal"><span class="pre">update.py</span></tt> did its job.</p>
</div>
<div class="section" id="running-update-py-from-pinboard-py">
<h3>Running <tt class="docutils literal"><span class="pre">update.py</span></tt> from <tt class="docutils literal"><span class="pre">pinboard.py</span></tt><a class="headerlink" href="#running-update-py-from-pinboard-py" title="Permalink to this headline">¶</a></h3>
<p>So now let&#8217;s update <tt class="docutils literal"><span class="pre">pinboard.py</span></tt> to call <tt class="docutils literal"><span class="pre">update.py</span></tt> instead of doing the
update itself:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105</pre></div></td><td class="code"><div class="highlight"><pre> <span class="c"># encoding: utf-8</span>

 <span class="kn">import</span> <span class="nn">sys</span>
<span class="hll"> <span class="kn">import</span> <span class="nn">os</span>
</span> <span class="kn">import</span> <span class="nn">argparse</span>
<span class="hll"> <span class="kn">import</span> <span class="nn">subprocess</span>
</span><span class="hll"> <span class="kn">from</span> <span class="nn">workflow</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Workflow</span><span class="p">,</span> <span class="n">ICON_WEB</span><span class="p">,</span> <span class="n">ICON_INFO</span><span class="p">,</span> <span class="n">ICON_WARNING</span><span class="p">,</span>
</span><span class="hll">                       <span class="n">PasswordNotFound</span><span class="p">)</span>
</span>

 <span class="k">def</span> <span class="nf">search_key_for_post</span><span class="p">(</span><span class="n">post</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;Generate a string search key for a post&quot;&quot;&quot;</span>
     <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
     <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">])</span>  <span class="c"># title of post</span>
     <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">])</span>  <span class="c"># post tags</span>
     <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;extended&#39;</span><span class="p">])</span>  <span class="c"># description</span>
     <span class="k">return</span> <span class="s">u&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>


 <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">wf</span><span class="p">):</span>

     <span class="c"># build argument parser to parse script args and collect their</span>
     <span class="c"># values</span>
     <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
     <span class="c"># add an optional (nargs=&#39;?&#39;) --apikey argument and save its</span>
     <span class="c"># value to &#39;apikey&#39; (dest). This will be called from a separate &quot;Run Script&quot;</span>
     <span class="c"># action with the API key</span>
     <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--setkey&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;apikey&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
     <span class="c"># add an optional query and save it to &#39;query&#39;</span>
     <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;query&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
     <span class="c"># parse the script&#39;s arguments</span>
     <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

     <span class="c">####################################################################</span>
     <span class="c"># Save the provided API key</span>
     <span class="c">####################################################################</span>

     <span class="c"># decide what to do based on arguments</span>
     <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">apikey</span><span class="p">:</span>  <span class="c"># Script was passed an API key</span>
         <span class="c"># save the key</span>
         <span class="n">wf</span><span class="o">.</span><span class="n">save_password</span><span class="p">(</span><span class="s">&#39;pinboard_api_key&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">apikey</span><span class="p">)</span>
         <span class="k">return</span> <span class="mi">0</span>  <span class="c"># 0 means script exited cleanly</span>

     <span class="c">####################################################################</span>
     <span class="c"># Check that we have an API key saved</span>
     <span class="c">####################################################################</span>

     <span class="k">try</span><span class="p">:</span>
<span class="hll">         <span class="n">wf</span><span class="o">.</span><span class="n">get_password</span><span class="p">(</span><span class="s">&#39;pinboard_api_key&#39;</span><span class="p">)</span>
</span>     <span class="k">except</span> <span class="n">PasswordNotFound</span><span class="p">:</span>  <span class="c"># API key has not yet been set</span>
         <span class="n">wf</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s">&#39;No API key set.&#39;</span><span class="p">,</span>
                     <span class="s">&#39;Please use pbsetkey to set your Pinboard API key.&#39;</span><span class="p">,</span>
                     <span class="n">valid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">icon</span><span class="o">=</span><span class="n">ICON_WARNING</span><span class="p">)</span>
         <span class="n">wf</span><span class="o">.</span><span class="n">send_feedback</span><span class="p">()</span>
         <span class="k">return</span> <span class="mi">0</span>

     <span class="c">####################################################################</span>
     <span class="c"># View/filter Pinboard posts</span>
     <span class="c">####################################################################</span>

     <span class="n">query</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">query</span>

<span class="hll">     <span class="c"># Get posts from cache. Set `data_func` to None, as we don&#39;t want to</span>
</span><span class="hll">     <span class="c"># update the cache in this script and `max_age` to 0 because we want</span>
</span><span class="hll">     <span class="c"># the cached data regardless of age</span>
</span><span class="hll">     <span class="n">posts</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">cached_data</span><span class="p">(</span><span class="s">&#39;posts&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">     <span class="c"># Start update script if cached data is too old (or doesn&#39;t exist)</span>
</span><span class="hll">     <span class="k">if</span> <span class="ow">not</span> <span class="n">wf</span><span class="o">.</span><span class="n">cached_data_fresh</span><span class="p">(</span><span class="s">&#39;posts&#39;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">600</span><span class="p">):</span>
</span><span class="hll">         <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;python&#39;</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">workflowfile</span><span class="p">(</span><span class="s">&#39;update.py&#39;</span><span class="p">)]</span>
</span><span class="hll">         <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">     <span class="c"># Notify the user if the cache is being updated</span>
</span><span class="hll">     <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">cachefile</span><span class="p">(</span><span class="s">&#39;update.pid&#39;</span><span class="p">)):</span>
</span><span class="hll">         <span class="n">wf</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s">&#39;Getting new posts from Pinboard&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">valid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">icon</span><span class="o">=</span><span class="n">ICON_INFO</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">     <span class="k">if</span> <span class="ow">not</span> <span class="n">posts</span><span class="p">:</span>  <span class="c"># we have no data to show, so stop here</span>
</span><span class="hll">         <span class="n">wf</span><span class="o">.</span><span class="n">send_feedback</span><span class="p">()</span>
</span><span class="hll">         <span class="k">return</span> <span class="mi">0</span>
</span>
     <span class="c"># If script was passed a query, use it to filter posts</span>
     <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
         <span class="n">posts</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">posts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">search_key_for_post</span><span class="p">)</span>

     <span class="c"># Loop through the returned posts and add a item for each to</span>
     <span class="c"># the list of results for Alfred</span>
     <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
         <span class="n">wf</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
         <span class="n">wf</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">],</span>
                     <span class="n">subtitle</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;href&#39;</span><span class="p">],</span>
                     <span class="n">arg</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s">&#39;href&#39;</span><span class="p">],</span>
                     <span class="n">valid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">icon</span><span class="o">=</span><span class="n">ICON_WEB</span><span class="p">)</span>

     <span class="c"># Send the results to Alfred as XML</span>
     <span class="n">wf</span><span class="o">.</span><span class="n">send_feedback</span><span class="p">()</span>
     <span class="k">return</span> <span class="mi">0</span>


 <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">u&quot;__main__&quot;</span><span class="p">:</span>
     <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">()</span>
     <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p>First of all, we&#8217;ve changed the imports a bit. We no longer need <a class="reference internal" href="web.html#module-workflow.web" title="workflow.web"><tt class="xref py py-mod docutils literal"><span class="pre">workflow.web</span></tt></a>,
because we&#8217;ll use <a class="reference external" href="http://docs.python.org/library/subprocess.html#module-subprocess" title="(in Python v2.7)"><tt class="xref py py-mod docutils literal"><span class="pre">subprocess</span></tt></a> to call <tt class="docutils literal"><span class="pre">update.py</span></tt> instead, and we&#8217;ve also
imported another icon (<tt class="docutils literal"><span class="pre">ICON_INFO</span></tt>) to show our update message. We&#8217;ll want
<a class="reference external" href="http://docs.python.org/library/os.html#module-os" title="(in Python v2.7)"><tt class="xref py py-mod docutils literal"><span class="pre">os</span></tt></a> as well to check if the <tt class="docutils literal"><span class="pre">update.pid</span></tt> file created by <tt class="docutils literal"><span class="pre">update.py</span></tt>
when it&#8217;s running exists, so we can tell if an update is currently running.</p>
<p>As noted before, <tt class="docutils literal"><span class="pre">get_recent_posts</span></tt> has now moved to <tt class="docutils literal"><span class="pre">update.py</span></tt>, as has
the <tt class="docutils literal"><span class="pre">wrapper</span></tt> function inside <tt class="docutils literal"><span class="pre">main</span></tt>.</p>
<p>Also in <tt class="docutils literal"><span class="pre">main</span></tt>, we no longer need <tt class="docutils literal"><span class="pre">api_key</span></tt>. However, we still want to know
if it has been saved, so we can show a warning if not, so we still call
<a class="reference internal" href="workflow.html#workflow.workflow.Workflow.get_password" title="workflow.workflow.Workflow.get_password"><tt class="xref py py-meth docutils literal"><span class="pre">Workflow.get_password()</span></tt></a>,
but without saving the result.</p>
<p>Most importantly, we&#8217;ve now expanded the update code to check if our cached data
is fresh with <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.cached_data_fresh" title="workflow.workflow.Workflow.cached_data_fresh"><tt class="xref py py-meth docutils literal"><span class="pre">Workflow.cached_data_fresh()</span></tt></a>
and to run the <tt class="docutils literal"><span class="pre">update.py</span></tt> script via <a class="reference external" href="http://docs.python.org/library/subprocess.html#subprocess.call" title="(in Python v2.7)"><tt class="xref py py-func docutils literal"><span class="pre">subprocess.call()</span></tt></a> if not
(<a class="reference internal" href="workflow.html#workflow.workflow.Workflow.workflowfile" title="workflow.workflow.Workflow.workflowfile"><tt class="xref py py-meth docutils literal"><span class="pre">Workflow.workflowfile()</span></tt></a>
returns the full path to a file in the Workflow&#8217;s root directory).</p>
<p>Then we check for the existence of the <tt class="docutils literal"><span class="pre">update.pid</span></tt> file created by <tt class="docutils literal"><span class="pre">update.py</span></tt>
when it&#8217;s running, and notify the user of any running update via Alfred&#8217;s results.</p>
<p>Finally, we call <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.cached_data" title="workflow.workflow.Workflow.cached_data"><tt class="xref py py-meth docutils literal"><span class="pre">Workflow.cached_data()</span></tt></a>
with <tt class="docutils literal"><span class="pre">None</span></tt> as the data-retrieval function because we don&#8217;t want to run an
update from this script, blocking Alfred. As a consequence, it&#8217;s possible that
we&#8217;ll get back <tt class="docutils literal"><span class="pre">None</span></tt> instead of a list of posts if there are no cached data,
so we check for this and exit the script if we have no posts to show.</p>
</div>
</div>
<div class="section" id="the-fruits-of-your-labour">
<h2>The fruits of your labour<a class="headerlink" href="#the-fruits-of-your-labour" title="Permalink to this headline">¶</a></h2>
<p>Now let&#8217;s give it a spin. Open up Alfred and enter <tt class="docutils literal"><span class="pre">pbrecent</span> <span class="pre">workflow:delcache</span></tt> to
clear the cached data. Then enter <a href="#id1"><span class="problematic" id="id2">``</span></a>pbrecent `` and start typing a query. You should see
the &#8220;Getting new posts from Pinboard&#8221; message appear. Unfortunately, we won&#8217;t
see any results at the moment because we just deleted the cached data.</p>
<p>To see our background updater weave its magic, we can change the <tt class="docutils literal"><span class="pre">max_age</span></tt> parameter
passed to <a class="reference internal" href="workflow.html#workflow.workflow.Workflow.cached_data" title="workflow.workflow.Workflow.cached_data"><tt class="xref py py-meth docutils literal"><span class="pre">Workflow.cached_data()</span></tt></a>
in <tt class="docutils literal"><span class="pre">update.py</span></tt> on line 109 and to
<a class="reference internal" href="workflow.html#workflow.workflow.Workflow.cached_data_fresh" title="workflow.workflow.Workflow.cached_data_fresh"><tt class="xref py py-meth docutils literal"><span class="pre">Workflow.cached_data_fresh()</span></tt></a>
in <tt class="docutils literal"><span class="pre">pinboard.py</span></tt> on line 70 to <tt class="docutils literal"><span class="pre">60</span></tt>. Open up Alfred, enter <a href="#id3"><span class="problematic" id="id4">``</span></a>pbrecent `` and
a couple of letters, then twiddle your thumbs for ~55 seconds. Type another letter
or two and you should see the &#8220;Getting new posts…&#8221; message <em>and</em> search
results. Cool, huh?</p>
</div>
<div class="section" id="sharing-your-workflow">
<h2>Sharing your Workflow<a class="headerlink" href="#sharing-your-workflow" title="Permalink to this headline">¶</a></h2>
<p>Now you&#8217;ve produced a technical marvel, it&#8217;s time to tell the world and enjoy
the well-earned plaudits. To build your Workflow, open it up in Alfred&#8217;s Preferences,
right-click on the Workflow&#8217;s name in the list on the left-hand side, and choose
<strong>Export…</strong>. This will save a <tt class="docutils literal"><span class="pre">.alfredworkflow</span></tt> file that you can share with
other people.</p>
<p>And how to do that?</p>
<p>There&#8217;s a <a class="reference external" href="http://www.alfredforum.com/forum/3-share-your-workflows/">Share your Workflows thread</a>
on <a class="reference external" href="http://www.alfredforum.com/">the official Alfred forum</a>, but being a forum,
it&#8217;s less than ideal as a directory for Workflows. Also, you&#8217;d need to find your own
place to host your Workflow file (for which GitHub and Dropbox are both good choices).</p>
<p>It&#8217;s a good idea to sign up for the Alfred forum and post a thread for your
Workflow, but you might want to consider uploading it to <a class="reference external" href="http://www.packal.org/">Packal.org</a>,
a site specifically designed for hosting Alfred Workflows. Your Workflow will
be much easier to find on that site than in the forum, and they&#8217;ll also host
the Workflow download for you.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Building a user-ready Workflow</a><ul>
<li><a class="reference internal" href="#performing-multiple-actions-from-one-script">Performing multiple actions from one script</a></li>
<li><a class="reference internal" href="#multi-step-actions">Multi-step actions</a></li>
<li><a class="reference internal" href="#saving-settings">Saving settings</a></li>
<li><a class="reference internal" href="#saving-settings-securely">Saving settings securely</a></li>
<li><a class="reference internal" href="#magic-arguments">&#8220;Magic&#8221; arguments</a></li>
<li><a class="reference internal" href="#logging">Logging</a></li>
<li><a class="reference internal" href="#spit-and-polish">Spit and polish</a></li>
<li><a class="reference internal" href="#two-actions-one-keyword">Two actions, one keyword</a></li>
<li><a class="reference internal" href="#like-greased-lightning-background-updates">Like greased lightning: background updates</a><ul>
<li><a class="reference internal" href="#background-updater-script">Background updater script</a></li>
<li><a class="reference internal" href="#running-update-py-from-pinboard-py">Running <tt class="docutils literal"><span class="pre">update.py</span></tt> from <tt class="docutils literal"><span class="pre">pinboard.py</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-fruits-of-your-labour">The fruits of your labour</a></li>
<li><a class="reference internal" href="#sharing-your-workflow">Sharing your Workflow</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="tutorial.html"
                        title="previous chapter">Writing a Pinboard.in Workflow with <strong>Alfred-Workflow</strong></a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="howto.html"
                        title="next chapter">Using <strong>Alfred-Workflow</strong></a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/tutorial2.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="howto.html" title="Using Alfred-Workflow"
             >next</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="Writing a Pinboard.in Workflow with Alfred-Workflow"
             >previous</a> |</li>
        <li><a href="index.html">Alfred-Workflow 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Dean Jackson.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>